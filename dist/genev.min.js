"use strict";(function(t,n){"undefined"!=typeof exports?n(t,exports,require("underscore")):"function"==typeof define&&define.amd?define(["underscore","exports"],function(i,s){t.Genev=n(t,s,i)}):t.Genev=n(t,{},t._)})(this,function(t,n,i){n.VERSION="0.0.1";var s={gaussRandom:function(){var t,n,i;do t=2*Math.random()-1,n=2*Math.random()-1,i=t*t+n*n;while(i>=1||0===i);var s=Math.sqrt(-2*Math.log(i)/i);return t*s},limit:function(t,n,i){return n>t?n:t>i?i:t},ringify:function(t){return t>1?t-1:0>t?1+t:t},probFn:function(t,n,i,s){var o,e=Array.prototype.slice.call(arguments),n=n||0;return e.length>4&&(o=e.slice(4),o.unshift(t)),n>Math.random()?o?i.apply(null,o):i(t):o?s.apply(null,o):s(t)},parseBoolean:function(t){return"true"===t?!0:!1},populateArray:function(t,n){return i.map(new Float32Array(t),function(){return n instanceof Array?new Float32Array(n):n})},generateMatrix:function(t,n,i){return this.populateArray(t,this.populateArray(n,i))},probab:function(t,n){return n=n||Math.random,t>n()},toType:function(t){return{}.toString.call(t).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()},rgbToHsb:function(t,n,i){var s,o,e,r,a,h,u,d,p=[];return r=t>n?t:n,i>r&&(r=i),a=n>t?t:n,a>i&&(a=i),e=r/255,o=0!==r?(r-a)/r:0,0===o?s=0:(h=(r-t)/(r-a),u=(r-n)/(r-a),d=(r-i)/(r-a),s=t===r?d-u:n===r?2+h-d:4+u-h,s/=6,0>s&&(s+=1)),p[0]=s,p[1]=o,p[2]=e,p},hsvToRgb:function(t,n,i){var s,o,e,r,a,h,u,d;if(0===n)return s=o=e=i,[Math.round(255*s),Math.round(255*o),Math.round(255*e)];switch(t*=6,r=Math.floor(t),a=t-r,h=i*(1-n),u=i*(1-n*a),d=i*(1-n*(1-a)),r){case 0:s=i,o=d,e=h;break;case 1:s=u,o=i,e=h;break;case 2:s=h,o=i,e=d;break;case 3:s=h,o=u,e=i;break;case 4:s=d,o=h,e=i;break;default:s=i,o=h,e=u}return[Math.round(255*s),Math.round(255*o),Math.round(255*e)]}},o=function(){},e={options:{useColor:!0,useSaturation:!0,width:100,height:100,maxAgents:10,minAgents:3,wrapAround:!0}},r=n.Individual=function(t){t=t||{};var n=i.clone(e.options);return this.startH=Math.random(),this.startS=Math.random(),this.startB=Math.random(),i.extend(n,t.options),t.options=n,i.extend(this,t),this.options.numAgents=this.options.numAgents||Math.round(Math.random()*(this.options.maxAgents-this.options.minAgents)+this.options.minAgents),this.agents=this.agents?this.agents[0]instanceof h?this.agents:i.map(this.agents,function(t){return new h(t)}):this.generateAgents(this.options),this.maxTime=2*this.options.width*this.options.height,this.time=0,this.developed=!1,this.h=s.generateMatrix(this.options.width,this.options.height,this.startH),this.s=s.generateMatrix(this.options.width,this.options.height,this.startS),this.b=s.generateMatrix(this.options.width,this.options.height,this.startB),this.initialize.apply(this,arguments),this};i.extend(r.prototype,{initialize:o,generateAgents:function(t){return i.map(i.range(t.numAgents),function(n,s){return new h({options:i.clone(t),index:s})})},step:function(t){var n,s,t=t||1;if(this.developed)return this;for(var o=0;t>o;++o)++this.time,i.each(this.agents,function(t){n=t.step(this,this.time),n&&(s=n.currPos(),this.h[s.x][s.y]=n.h,this.s[s.x][s.y]=n.s,this.b[s.x][s.y]=n.b,n.nextPos())},this);return this.time>=this.maxTime&&(this.developed=!0),this},clone:function(){var t=i.map(this.agents,function(t,n,i){return i[n].clone().setIndex(n)},this);return new r({options:i.clone(this.options),startH:this.startH,startS:this.startS,startB:this.startB,agents:t})},mutate:function(t){var n,o,a=this.options.numAgents,u=[],d=this.options.wrapAround,p=i.map([this.startH,this.startS,this.startB],function(n,i,o){return s.probab(t)?s.ringify(o[i]+s.gaussRandom()):o[i]});return s.probab(2*t)&&this.options.numAgents<e.maxAgents-1?(++a,u=i.map(i.range(a-1),function(t,n){return this.agents[n].clone().setIndex(n)},this),n=a-1,s.probab(.75)?u[n]=new h({options:i.clone(this.options),index:n}):(o=Math.floor(Math.random()*n),u[a-1]=this.agents[o].clone().setIndex(n))):s.probab(2*t)&&this.options.numAgents>e.minAgents?(--a,u=i.map(i.range(a),function(t,n){return this.agents[n].clone().setIndex(n)},this),o=Math.floor(Math.random()*a),u[o]=this.agents[a].clone().setIndex(o)):u=i.map(i.range(a),function(t,n){return this.agents[n].clone().setIndex(n)},this),new r({options:i.extend(i.clone(this.options),{wrapAround:d,numAgents:a}),startH:p[0],startS:p[1],startB:p[2],agents:u})},crossover:function(t){var n,o,e=s.probab(.5)?t.options.numAgents:this.options.numAgents,a=s.probab(.5)?t.options.wrapAround:this.options.wrapAround,h=s.probab(.5)?t.startH:this.startH,u=s.probab(.5)?t.startS:this.startS,d=s.probab(.5)?t.startB:this.startB;return n=i.map(i.range(e),function(n,i){return s.probab(.33)?this.agents[Math.floor(Math.random()*this.options.numAgents)].clone().setIndex(i):s.probab(.5)?(o=t.agents[Math.floor(Math.random()*t.options.numAgents)],this.agents[Math.floor(Math.random()*this.options.numAgents)].crossover(o).setIndex(i)):this.agents[Math.floor(Math.random()*this.options.numAgents)].clone().setIndex(i)},this),new r(i.extend(i.clone(this.options),{options:i.extend(i.clone(this.options),{wrapAround:a,numAgents:e}),startH:h,startS:u,startB:d,agents:n}))},toJSON:function(){return JSON.stringify(i.pick(this,"options","startH","startS","startB","agents"))},fromJSON:function(t){var n=JSON.parse(t);return new r(n)},fromRGBA:function(t){for(var n,i,o,e,r,a,h=this.options.width,u=this.options.height,d=t,p=0,m=0,c=0,g=0;u>g;++g){n=h*g;for(var l=0;h>l;++l)o=d[4*(n+l)],e=d[4*(n+l)+1],r=d[4*(n+l)+2],a=d[4*(n+l)+3],i=s.rgbToHsb(o,e,r),this.h[l][g]=i[0],this.s[l][g]=i[1],this.b[l][g]=i[2],p+=i[0],m+=i[1],c+=i[2]}return this.startH=p/(h*u),this.startS=m/(h*u),this.startB=c/(h*u),this},getRGBA:function(){for(var t,n,i=this.options.width,o=this.options.height,e=this.h,r=this.s,a=this.b,h=new Uint8ClampedArray(4*i*o),u=0;o>u;++u){t=i*u;for(var d=0;i>d;++d)n=s.hsvToRgb(e[d][u],r[d][u],a[d][u]),h[4*(t+d)]=n[0],h[4*(t+d)+1]=n[1],h[4*(t+d)+2]=n[2],h[4*(t+d)+3]=255}return h}});var a={x:0,y:0,dir:0,delay:0,delayInt:0,stop:1,stopInt:99999999,gen:0,genTime1:0,genTime2:0,index:1,options:{width:100,height:100,wrapAround:!0,maxAgents:3}},h=n.Agent=function(t){t=t||{};var n=i.clone(a.options);return i.extend(n,t.options),t.options=n,i.extend(this,this._randomizedAttributes(),i.omit(a,"options"),t),this.genome=t.genome?t.genome instanceof p?t.genome:new p(t.genome):new p,i.extend(this,this._setPositionOnGrid()),this._originalAttributes=i.clone(i.pick(this,["dir","gen","genTime1","genTime2","delay","stop","options"])),this.initialize.apply(this,arguments),this};i.extend(h.prototype,{initialize:o,setIndex:function(t){return this.index=t,i.extend(this,this._setPositionOnGrid()),this},mutate:function(t){var n,i=t>Math.random()?Math.floor(9*Math.random()):this._originalAttributes.dir,o=t>Math.random()?s.ringify(this.gen+.2*s.gaussRandom()):this.gen,e=t>Math.random()?s.ringify(this.genTime1+.2*s.gaussRandom()):this.genTime1,r=t>Math.random()?s.ringify(this.genTime2+.2*s.gaussRandom()):this.genTime2,a=t>Math.random()?s.ringify(this.delay+.1*s.gaussRandom()):this.delay,u=t>Math.random()?s.ringify(this.stop+.1*s.gaussRandom()):this.stop;return a>u&&(n=a,a=u,u=n),new h({options:this.options,genome:this.genome.mutate(t),dir:i,gen:o,genTime1:e,genTime2:r,delay:a,stop:u})},crossover:function(t){var n=.5,i=n>Math.random()?t.gen:this.gen,s=n>Math.random()?t.genTime1:this.genTime1,o=n>Math.random()?t.genTime2:this.genTime2,e=n>Math.random()?t.delay:this.delay,r=n>Math.random()?t.stop:this.stop;return new h({options:this.options,genome:this.genome.crossover(t.genome),dir:this._originalAttributes.dir,gen:i,genTime1:s,genTime2:o,delay:e,stop:r})},clone:function(){return new h({options:this.options,dir:this._originalAttributes.dir,gen:this.gen,genTime1:this.genTime1,genTime2:this.genTime2,delay:this.delay,stop:this.stop,genome:this.genome.clone()})},step:function(t,n){if(!(this.delayInt>n||n>this.stopInt)){var s=this._collectInputs(t,n),o=this.genome.evaluate(s),e=this._getNextPosition(this._floatToDir(o[3])),r={nextPos:i.partial(i.bind(function(t){return this.x=t.x,this.y=t.y,t},this),e),currPos:i.partial(function(t){return{x:t.x,y:t.y}},this),h:o[0],s:o[1],b:o[2]};return r}},_collectInputs:function(t,n){for(var i,s,o,e,r,a,h,u,d,p,m,c,g=0,l=0,f=1,b=0,M=0,y=1e3*this.genTime1,y=1>y?1:y,x=1e3*this.genTime2,x=1>x?1:x,v=n%y/y,N=n%x/x,A=-1,T=-1,w=-1,_=-1,S=0,I=0,B=Math.random(),H=t.b[this.x][this.y],F=t.s[this.x][this.y],P=t.h[this.x][this.y],R=this._inverseDirection(this.dir),D=this._dirToFloat(R),k=this._getNextPosition(R),O=t.b[k.x][k.y],C=t.s[k.x][k.y],J=t.h[k.x][k.y],z=0,G=0,q=-1,E=0,L=Array(9),U=0;9>U;++U)i=this._getNextPosition(U),s=t.h[i.x][i.y],o=t.s[i.x][i.y],e=t.b[i.x][i.y],M+=s,b+=o,g+=e,r=Math.pow(s-H,2)+Math.pow(o-F,2)+Math.pow(e-H,2),r>q&&(q=r,E=U),e>l&&(l=e,z=U),f>e&&(f=e,G=U);g/=9,b/=9,M/=9,a=this._dirToFloat(z),h=this._dirToFloat(G),u=this._dirToFloat(E);for(var U=0;8>U;++U)i=this._getNextPosition(U),e=t.b[i.x][i.y],e>=g&&(L[U]=!0);for(var U=0;8>U;++U)d=Math.random(),p=Math.random(),m=U-1,m=1>m?7:m,c=U+1,c=c>=8?1:c,L[U]?((0>w||.3>d)&&(w=this._dirToFloat(U)),0!==L[m]&&0!==L[c]||!(0>T||.3>p)||(T=this._dirToFloat(U),I=T)):((0>_||.3>d)&&(_=this._dirToFloat(U)),0===L[m]&&0===L[c]||!(0>A||.3>p)||(A=this._dirToFloat(U),S=A));return w=0>w?this.gen:w,_=0>_?this.gen:_,A=0>A?this.gen:A,T=0>T?this.gen:T,[B,H,g,l,f,h,O,F,b,C,P,M,J,D,u,w,_,this.gen,v,N,A,T,t.startH,t.startS,t.startB,S,I]},toJSON:function(){return i.pick(this,"dir","gen","genTime1","genTime2","delay","stop","genome","options")},fromJSON:function(t){var n=JSON.parse(t);return new h(n)},_randomizedAttributes:function(t){t=t||Math.random();var n=Math.floor(9*Math.random()),i=Math.random(),s=Math.random(),o=Math.random(),e=.33>Math.random()?0:.33*Math.random(),r=.33>Math.random()?1:.66*Math.random()+.33;return.2>t?(e=0,r=.5*Math.random()):.4>t&&(e=.4000000059604645*Math.random()+.3,r=1),{dir:n,gen:i,genTime1:s,genTime2:o,delay:e,stop:r}},_setPositionOnGrid:function(){var t=2*this.options.width*this.options.height,n=Math.round(t*this.delay),i=Math.round(t*this.stop),s=Math.sqrt(this.options.maxAgents),o=this.index/s*(this.options.width/s)+.1*this.options.width,e=this.index%s*(this.options.height/s)+.1*this.options.height,o=o>=this.options.width?this.options.width-.2*this.options.width:o,e=e>=this.options.height?this.options.height-.2*this.options.height:e,r=Math.floor(o),a=Math.floor(e);return{delayInt:n,stopInt:i,x:r,y:a}},_getNextPosition:function(t){var n=[this.x,this.y],i=this.options.wrapAround,s=this.options.width,o=this.options.height;switch(t){case 1:n[0]-=1;break;case 2:n[0]-=1,n[1]-=1;break;case 3:n[1]-=1;break;case 4:n[0]+=1,n[1]-=1;break;case 5:n[0]+=1;break;case 6:n[0]+=1,n[1]+=1;break;case 7:n[1]+=1;break;case 8:n[0]-=1,n[1]+=1}return n[0]=0>n[0]?i?s-1:0:n[0],n[0]=n[0]>=s?i?0:s-1:n[0],n[1]=0>n[1]?i?o-1:0:n[1],n[1]=n[1]>=o?i?0:o-1:n[1],{x:n[0],y:n[1]}},_inverseDirection:function(t){var n;return 0===t?0:(n=(t+4)%8,0===n&&(n=8),n)},_dirToFloat:function(t){return t/9},_floatToDir:function(t){return parseInt(9*t)}});var u={add:function(t,n){return t+n},sub:function(t,n){return t-n},mult:function(t,n){return t*n},ind:function(t,n,i){return this.constArr[i]},min:function(t,n){return n>t?t:n},max:function(t,n){return t>n?t:n},sin:function(t){return Math.sin(t)},atan:function(t){return Math.atan(t)},id:function(t){return t},mean:function(t,n){return t+n/2},realmean:function(t,n){return(t+n)/2},div:function(t,n){return Number.MIN_VALUE>n?t:Math.round(t/n)},incdec:function(t,n){return n>.5?t+.125:t-.125},inv:function(t){return 1-t}},d={options:{agentTreeDepth:3,agentInputs:27,biasHTree:!1,biasSTree:!1,biasBTree:!1,biasNoChange:!1}},p=n.Genome=function(t){t=t||{};var n=i.clone(d.options);i.extend(n,t.options),t.options=n,i.extend(this,t),this.numTotalNodes=this.numTotalNodes||Math.floor(Math.pow(2,this.options.agentTreeDepth+1)-1),this.numInputNodes=this.numInputNodes||Math.floor(Math.pow(2,this.options.agentTreeDepth)),this.numProcessNodes=this.numProcessNodes||this.numTotalNodes-this.numInputNodes,this.inputsH=this.inputsH||i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),this.options.biasNoChange,0,!0),this.inputsS=this.inputsS||i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),this.options.biasNoChange,1,!0),this.inputsB=this.inputsB||i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),this.options.biasNoChange,2,!0),this.inputsDir=this.inputsDir||i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),!1,0,!0),this.nodesH=this.nodesH||i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,this.options.biasNoChange),this.nodesS=this.nodesS||i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,this.options.biasNoChange),this.nodesB=this.nodesB||i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,this.options.biasNoChange),this.nodesDir=this.nodesDir||i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,!1),this.constArr=this.constArr||i.map(i.range(this.numProcessNodes),Math.random),(this.options.biasHTree||this.options.biasSTree||this.options.biasBTree&&!t.constArr)&&(this.constArr[0]=.4*Math.random()+.3),this.options.biasSTree&&!t.nodesS&&(this.nodesS[0]="ind"),this.options.biasBTree&&!t.nodesB&&(this.nodesB[0]="ind"),this.initialize.apply(this,arguments)};i.extend(p.prototype,{initialize:o,clone:function(){return new p({inputsH:this.inputsH.slice(0),inputsS:this.inputsS.slice(0),inputsB:this.inputsB.slice(0),inputsDir:this.inputsDir.slice(0),nodesH:this.nodesH.slice(0),nodesS:this.nodesS.slice(0),nodesB:this.nodesB.slice(0),nodesDir:this.nodesDir.slice(0),constArr:this.constArr.slice(0),numTotalNodes:this.numTotalNodes,numInputNodes:this.numInputNodes,numProcessNodes:this.numProcessNodes,options:i.clone(this.options)})},mutate:function(t){var n=this.clone();return n.inputsH=i.map(n.inputsH,function(n){return s.probFn(n,t,this._getRandomInput,u.id,!1,0,!1)}),n.inputsS=i.map(n.inputsS,function(n){return s.probFn(n,t,this._getRandomInput,u.id,!1,1,!1)}),n.inputsB=i.map(n.inputsB,function(n){return s.probFn(n,t,this._getRandomInput,u.id,!1,2,!1)}),n.inputsDir=i.map(n.inputsDir,function(n){return s.probFn(n,t,this._getRandomInput,u.id,!1,0,!1)}),n.nodesH=i.map(n.nodesH,function(n){return s.probFn(n,t,this._getRandomFunction,u.id,!1)}),n.nodesS=i.map(n.nodesS,function(n){return s.probFn(n,t,this._getRandomFunction,u.id,!1)}),n.nodesB=i.map(n.nodesB,function(n){return s.probFn(n,t,this._getRandomFunction,u.id,!1)}),n.nodesDir=i.map(n.nodesDir,function(n){return s.probFn(n,t,function(){return Math.floor(Math.random()*u.length)},u.id)}),n.constArr=i.map(n.constArr,function(n){return s.probFn(n,t,function(t){return s.limit(t+.2*s.gaussRandom())},u.id)}),n},crossover:function(t){if(t instanceof p){var n,s=.5,o=i.pick(this.numProcessNodes>t.numProcessNodes?this:t,"inputsH","inputsS","inputsB","inputsDir","nodesH","nodesS","nodesB","nodesDir","constArr"),e=i.map(o,function(o,e){return n=i.map(o,function(n,i){return s>Math.random()?t[e][i]||n:n||t[e][i]})}),r={};return i.each(o.options,function(t,n){r[n]=t}),new p({inputsH:e[0],inputsS:e[1],inputsB:e[2],inputsDir:e[3],nodesH:e[4],nodesS:e[5],nodesB:e[6],nodesDir:e[7],constArr:e[8],numTotalNodes:o.numTotalNodes,numInputNodes:o.numInputNodes,numProcessNodes:o.numProcessNodes,options:r})}throw new TypeError("Genev.js: to crossover a genome, another genome must be provided!")},evaluate:function(t){for(var n,i,o=new Float32Array(this.numTotalNodes),e=new Float32Array(this.numTotalNodes),r=new Float32Array(this.numTotalNodes),a=new Float32Array(this.numTotalNodes),h=this.numProcessNodes;this.numTotalNodes-1>h;h++)o[h]=t[this.inputsH[h-this.numProcessNodes]]||0,e[h]=t[this.inputsS[h-this.numProcessNodes]]||0,r[h]=t[this.inputsB[h-this.numProcessNodes]]||0,a[h]=t[this.inputsDir[h-this.numProcessNodes]]||0;for(var h=this.numProcessNodes-1;h>=0;h--)n=2*h+1,i=2*h+2,o[h]=s.ringify(u[this.nodesH[h]].apply(this,[o[n],o[i],h])),e[h]=s.ringify(u[this.nodesS[h]].apply(this,[e[n],e[i],h])),r[h]=s.ringify(u[this.nodesB[h]].apply(this,[r[n],r[i],h])),a[h]=s.ringify(u[this.nodesDir[h]].apply(this,[a[n],a[i],h]));return[o[0],e[0],r[0],a[0]]},toJSON:function(){return i.pick(this,"inputsH","inputsS","inputsB","inputsDir","nodesH","nodesS","nodesB","nodesDir","constArr","numTotalNodes","numInputNodes","numProcessNodes","options")},fromJSON:function(t){var n=JSON.parse(t);return new p(n)},_getRandomInput:function(t,n,i){var s=Math.random();return t?0===n?.33>s?11:.66>s?12:13:1===n?.33>s?8:.66>s?9:10:.2>s?1:.4>s?2:.6>s?3:.8>s?5:7:i?Math.floor(Math.random()*(this.options.agentInputs-1)+1):Math.random()*this.options.agentInputs},_getRandomFunction:function(t){var n=Math.random();return t?.01>n?"add":.02>n?"sub":.03>n?"mult":.04>n?"ind":.05>n?"max":.06>n?"min":.8>n?"div":.85>n?"id":.88>n?"realmean":.9>n?"atan":.98>n?"incdec":.99>n?"sin":"inv":.05>n?"add":.1>n?"sub":.15>n?"mult":.25>n?"ind":.3>n?"max":.35>n?"min":.5>n?"atan":.6>n?"id":.82>n?"realmean":.85>n?"div":.95>n?"incdec":.98>n?"sin":"inv"}});var m=function(t,n){var s,o=this;s=t&&i.has(t,"constructor")?t.constructor:function(){return o.apply(this,arguments)},i.extend(s,o,n);var e=function(){this.constructor=s};return e.prototype=o.prototype,s.prototype=new e,t&&i.extend(s.prototype,t),s.__super__=o.prototype,s};return r.extend=h.extend=p.extend=m,n});