"use strict";(function(t,n){"undefined"!=typeof exports?n(t,exports,require("underscore")):"function"==typeof define&&define.amd?define(["underscore","exports"],function(i,s){t.Genev=n(t,s,i)}):t.Genev=n(t,{},t._)})(this,function(t,n,i){n.VERSION="0.0.1";var s={useColor:!0,useSaturation:!0,worldWidth:270,worldHeight:160,maxAgents:10,minAgents:5,agentTreeDepth:3,agentInputs:27,biasHTree:!1,biasSTree:!1,biasBTree:!1,biasNoChange:!1},e={gaussRandom:function(){var t,n,i;do t=2*Math.random()-1,n=2*Math.random()-1,i=t*t+n*n;while(i>=1||0===i);var s=Math.sqrt(-2*Math.log(i)/i);return t*s},limit:function(t,n,i){return n>t?n:t>i?i:t},ringify:function(t){return t>1?t-1:0>t?1+t:t},probFn:function(t,n,i,s){var e,r=Array.prototype.slice.call(arguments),n=n||0;return r.length>4&&(e=r.slice(4),e.unshift(t)),n>Math.random()?e?i.apply(null,e):i(t):e?s.apply(null,e):s(t)},parseBoolean:function(t){return"true"===t?!0:!1},populateArray:function(t,n){return i.map(new Float32Array(t),function(){return n instanceof Array?new Float32Array(n):n})},generateMatrix:function(t,n,i){return this.populateArray(t,this.populateArray(n,i))},probab:function(t,n){return n=n||Math.random,t>n()},hsvToRgb:function(t,n,i){var s,e,r,a,o,h,u,d;if(0===n)return s=e=r=i,[Math.round(255*s),Math.round(255*e),Math.round(255*r)];switch(t*=6,a=Math.floor(t),o=t-a,h=i*(1-n),u=i*(1-n*o),d=i*(1-n*(1-o)),a){case 0:s=i,e=d,r=h;break;case 1:s=u,e=i,r=h;break;case 2:s=h,e=i,r=d;break;case 3:s=h,e=u,r=i;break;case 4:s=d,e=h,r=i;break;default:s=i,e=h,r=u}return[Math.round(255*s),Math.round(255*e),Math.round(255*r)]}},r=function(){},a=n.Individual=function(t){var n,r,a=Array.prototype.slice.call(arguments);if((n=i.result(this,"defaults"))&&i.extend(this,n),"string"!=typeof t&&i.extend(this,t),"string"==typeof a[0]){r=a[0].split("::"),this.numAgents=parseInt(r[0]),this.width=parseInt(r[1]),this.height=parseInt(r[2]),this.wrapAround=e.parseBoolean(r[3]),this.startH=parseFloat(r[4]),this.startS=parseFloat(r[5]),this.startB=parseFloat(r[6]),this.agents=[];for(var h=0;this.numAgents>h;++h)this.agents[h]=new o(r[7+h]).setIndex(h)}else this.startH=this.startH||Math.random(),this.startS=this.startS||Math.random(),this.startB=this.startB||Math.random(),this.numAgents=this.numAgents||Math.round(Math.random()*(s.maxAgents-s.maxAgents)+s.maxAgents),this.agents=this.agents||this.generateAgents(this.numAgents,this.width,this.height,this.wrapAround);return this.maxTime=2*this.width*this.height,this.time=0,this.developed=!1,this.h=e.generateMatrix(this.width,this.height,this.startH),this.s=e.generateMatrix(this.width,this.height,this.startS),this.b=e.generateMatrix(this.width,this.height,this.startB),i.each(this.agents,function(t){t.wrapAround=this.wrapAround},this),this.initialize.apply(this,arguments),this};i.extend(a.prototype,{defaults:{wrapAround:!0,width:1024,height:768},initialize:r,generateAgents:function(t,n,s,e){return t=t||this.numAgents,n=n||this.width,s=s||this.height,e=e||this.wrapAround,i.map(i.range(t),function(t,i){return new o({index:i,width:n,height:s,wrapAround:e})})},step:function(){var t,n;return this.developed?this:(++this.time,i.each(this.agents,function(i){t=i.step(this,this.time),t&&(n=t.currPos(),this.h[n.x][n.y]=t.h,this.s[n.x][n.y]=t.s,this.b[n.x][n.y]=t.b,t.nextPos())},this),this.time>=this.maxTime&&(this.developed=!0),this)},clone:function(){var t=i.map(i.range(this.numAgents),function(t,n){return this.agents[n].clone().setIndex(n)},this);return new a({width:this.width,height:this.height,wrapAround:this.wrapAround,numAgents:this.numAgents,startH:this.startH,startS:this.startS,startB:this.startB,agents:t})},mutate:function(t){var n,r,h=this.numAgents,u=[],d=this.wrapAround,g=i.map([this.startH,this.startS,this.startB],function(n,i,s){return e.probab(t)?e.ringify(s[i]+e.gaussRandom()):s[i]});return e.probab(2*t)&&this.numAgents<s.maxAgents-1?(++h,u=i.map(i.range(h-1),function(t,n){return this.agents[n].clone().setIndex(n)},this),n=h-1,e.probab(.75)?u[n]=new o({index:n,width:this.width,height:this.height,wrapAround:this.wrapAround}):(r=Math.floor(Math.random()*n),u[h-1]=this.agents[r].clone().setIndex(n))):e.probab(2*t)&&this.numAgents>s.minAgents?(--h,u=i.map(i.range(h),function(t,n){return this.agents[n].clone().setIndex(n)},this),r=Math.floor(Math.random()*h),u[r]=this.agents[h].clone().setIndex(r)):u=i.map(i.range(h),function(t,n){return this.agents[n].clone().setIndex(n)},this),new a({width:this.width,height:this.height,wrapAround:d,numAgents:h,startH:g[0],startS:g[1],startB:g[2],agents:u})},crossover:function(t){var n,s,r=e.probab(.5)?t.numAgents:this.numAgents,o=e.probab(.5)?t.wrapAround:this.wrapAround,h=e.probab(.5)?t.startH:this.startH,u=e.probab(.5)?t.startS:this.startS,d=e.probab(.5)?t.startB:this.startB;return n=i.map(i.range(r),function(n,i){return e.probab(.33)?this.agents[Math.floor(Math.random()*this.numAgents)].clone().setIndex(i):e.probab(.5)?(s=t.agents[Math.floor(Math.random()*t.numAgents)],this.agents[Math.floor(Math.random()*this.numAgents)].crossover(s).setIndex(i)):this.agents[Math.floor(Math.random()*this.numAgents)].clone().setIndex(i)},this),new a({width:this.width,height:this.height,wrapAround:o,numAgents:r,startH:h,startS:u,startB:d,agents:n})},toGenomeString:function(){for(var t=this.numAgents+"::"+this.width+"::"+this.height+"::"+this.wrapAround+"::"+this.startH+"::"+this.startS+"::"+this.startB+"::",n=0;this.numAgents>n;++n)t+=this.agents[n].toGenomeString()+"::";return t}});var o=n.Agent=function(t){var n,s,t=t||{},e=Array.prototype.slice.call(arguments);return(n=i.result(this,"defaults"))&&i.extend(this,n),this.genome=new d,i.extend(this,this._randomizedAttributes()),1===e.length&&("string"==typeof e[0]?(s=e[0].split("#"),s&&8===s.length&&(this.dir=parseInt(s[0]),this.gen=parseFloat(s[1]),this.genTime1=parseFloat(s[2]),this.genTime2=parseFloat(s[3]),this.delay=parseFloat(s[4]),this.stop=parseFloat(s[5]),this.genome=new d(s[6]))):i.extend(this,t)),i.extend(this,this._randomizedGridIndex()),this._originalAttributes=i.clone(this),this.initialize.apply(this,arguments),this};i.extend(o.prototype,{defaults:{x:0,y:0,dir:0,delay:0,delayInt:0,stop:1,stopInt:99999999,gen:0,genTime1:0,genTime2:0,wrapAround:!0,width:100,height:100,index:1},initialize:r,setIndex:function(t){return this.index=t,i.extend(this,this._randomizedAttributes()),this},mutate:function(t){var n,i=t>Math.random()?Math.floor(9*Math.random()):this._originalAttributes.dir,s=t>Math.random()?e.ringify(this.gen+.2*e.gaussRandom()):this.gen,r=t>Math.random()?e.ringify(this.genTime1+.2*e.gaussRandom()):this.genTime1,a=t>Math.random()?e.ringify(this.genTime2+.2*e.gaussRandom()):this.genTime2,h=t>Math.random()?e.ringify(this.delay+.1*e.gaussRandom()):this.delay,u=t>Math.random()?e.ringify(this.stop+.1*e.gaussRandom()):this.stop;return h>u&&(n=h,h=u,u=n),new o({x:this.x,y:this.y,wrapAround:this.wrapAround,genome:this.genome.mutate(t),dir:i,gen:s,genTime1:r,genTime2:a,delay:h,stop:u})},crossover:function(t){var n=.5,i=n>Math.random()?t.gen:this.gen,s=n>Math.random()?t.genTime1:this.genTime1,e=n>Math.random()?t.genTime2:this.genTime2,r=n>Math.random()?t.delay:this.delay,a=n>Math.random()?t.stop:this.stop;return new o({x:this.x,y:this.y,wrapAround:this.wrapAround,genome:this.genome.crossover(t.genome),dir:this._originalAttributes.dir,gen:i,genTime1:s,genTime2:e,delay:r,stop:a})},step:function(t,n){if(!(this.delayInt>n||n>this.stopInt)){var s=this.collectInputs(t,n),e=this.genome.evaluate(s),r=this._getNextPosition(this._floatToDir(e[3])),a={nextPos:i.partial(i.bind(function(t){return this.x=t.x,this.y=t.y,t},this),r),currPos:i.partial(function(t){return{x:t.x,y:t.y}},this),h:e[0],s:e[1],b:e[2]};return a}},collectInputs:function(t,n){for(var i,s,e,r,a,o,h,u,d,g,m,p,c=0,l=0,f=1,A=0,y=0,b=1e3*this.genTime1,b=1>b?1:b,w=1e3*this.genTime2,w=1>w?1:w,M=n%b/b,x=n%w/w,v=-1,T=-1,_=-1,I=-1,F=0,N=0,S=Math.random(),B=t.b[this.x][this.y],H=t.s[this.x][this.y],R=t.h[this.x][this.y],P=this._inverseDirection(this.dir),D=this._dirToFloat(P),k=this._getNextPosition(P),z=t.b[k.x][k.y],G=t.s[k.x][k.y],U=t.h[k.x][k.y],C=0,q=0,E=-1,V=0,W=Array(9),L=0;9>L;++L)i=this._getNextPosition(L,this.attributes),s=t.h[i.x][i.y],e=t.s[i.x][i.y],r=t.b[i.x][i.y],y+=s,A+=e,c+=r,a=Math.pow(s-B,2)+Math.pow(e-H,2)+Math.pow(r-B,2),a>E&&(E=a,V=L),r>l&&(l=r,C=L),f>r&&(f=r,q=L);c/=9,A/=9,y/=9,o=this._dirToFloat(C),h=this._dirToFloat(q),u=this._dirToFloat(V);for(var L=0;8>L;++L)i=this._getNextPosition(L,this.attributes),r=t.b[i.x][i.y],r>=c&&(W[L]=!0);for(var L=0;8>L;++L)d=Math.random(),g=Math.random(),m=L-1,m=1>m?7:m,p=L+1,p=p>=8?1:p,W[L]?((0>_||.3>d)&&(_=this._dirToFloat(L)),0!==W[m]&&0!==W[p]||!(0>T||.3>g)||(T=this._dirToFloat(L),N=T)):((0>I||.3>d)&&(I=this._dirToFloat(L)),0===W[m]&&0===W[p]||!(0>v||.3>g)||(v=this._dirToFloat(L),F=v));return _=0>_?this.gen:_,I=0>I?this.gen:I,v=0>v?this.gen:v,T=0>T?this.gen:T,[S,B,c,l,f,h,z,H,A,G,R,y,U,D,u,_,I,this.gen,M,x,v,T,t.startH,t.startS,t.startB,F,N]},clone:function(){return new o(this.attributes)},toPrettyString:function(){var t="A "+this.index+" = {"+" ("+this._originalAttributes.x+","+this._originalAttributes.y+"), "+"dir: "+this._originalAttributes.dir+", "+"a_g: "+this.gen+", "+"a_{t_1}: "+this.genTime1+", "+"a_{t_2}: "+this.genTime2+", "+"a_{start}: "+this.delay+", "+"a_{stop}: "+this.stop+"}";return t},toGenomeString:function(){var t=this._originalAttributes.dir+"#"+this.gen+"#"+this.genTime1+"#"+this.genTime2+"#"+this.delay+"#"+this.stop+"#"+this.genome.toGenomeString()+"#";return t},_randomizedAttributes:function(t){t=t||Math.random();var n=Math.floor(9*Math.random()),i=Math.random(),s=Math.random(),e=Math.random(),r=.33>Math.random()?0:.33*Math.random(),a=.33>Math.random()?1:.66*Math.random()+.33;return.2>t?(r=0,a=.5*Math.random()):.4>t&&(r=.4000000059604645*Math.random()+.3,a=1),{dir:n,gen:i,genTime1:s,genTime2:e,delay:r,stop:a}},_randomizedGridIndex:function(){var t=2*this.width*this.height,n=Math.round(t*this.delay),i=Math.round(t*this.stop),e=Math.sqrt(s.maxAgents),r=this.index/e*(s.worldWidth/e)+.1*this.width,a=this.index%e*(s.worldHeight/e)+.1*this.height,r=r>=this.width?this.width-.2*this.width:r,a=a>=this.height?this.height-.2*this.height:a,o=Math.floor(r),h=Math.floor(a);return{delayInt:n,stopInt:i,x:o,y:h}},_getNextPosition:function(t){var n=[this.x,this.y],i=this.wrapAround,s=this.width,e=this.height;switch(t){case 1:n[0]-=1;break;case 2:n[0]-=1,n[1]-=1;break;case 3:n[1]-=1;break;case 4:n[0]+=1,n[1]-=1;break;case 5:n[0]+=1;break;case 6:n[0]+=1,n[1]+=1;break;case 7:n[1]+=1;break;case 8:n[0]-=1,n[1]+=1}return n[0]=0>n[0]?i?s-1:0:n[0],n[0]=n[0]>=s?i?0:s-1:n[0],n[1]=0>n[1]?i?e-1:0:n[1],n[1]=n[1]>=e?i?0:e-1:n[1],{x:n[0],y:n[1]}},_inverseDirection:function(t){var n;return 0===t?0:(n=(t+4)%8,0===n&&(n=8),n)},_dirToFloat:function(t){return t/9},_floatToDir:function(t){return parseInt(9*t)}});var h=["inputsH","inputsS","inputsB","inputsDir","nodesH","nodesS","nodesB","nodesDir","constArr"],u={add:function(t,n){return t+n},sub:function(t,n){return t-n},mult:function(t,n){return t*n},ind:function(t,n,i){return this.constArr[i]},min:function(t,n){return n>t?t:n},max:function(t,n){return t>n?t:n},sin:function(t){return Math.sin(t)},id:function(t){return t},mean:function(t,n){return t+n/2},realmean:function(t,n){return(t+n)/2},div:function(t,n){return Number.MIN_VALUE>n?t:Math.round(t/n)},incdec:function(t,n){return n>.5?t+.125:t-.125},inv:function(t){return 1-t}},d=n.Genome=function(){var t,n,e=Array.prototype.slice.apply(arguments);if(1===e.length&&e[0]instanceof Array?e=e[0]:1===e.length&&"string"==typeof e[0]&&(t=e[0].split("!")),this.numTotalNodes=Math.floor(Math.pow(2,s.agentTreeDepth+1)-1),this.numInputNodes=Math.floor(Math.pow(2,s.agentTreeDepth)),this.numProcessNodes=this.numTotalNodes-this.numInputNodes,this.inputsH=new Uint8Array(i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),s.biasNoChange,0,!0)),this.inputsS=new Uint8Array(i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),s.biasNoChange,1,!0)),this.inputsB=new Uint8Array(i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),s.biasNoChange,2,!0)),this.inputsDir=new Uint8Array(i.invoke(i.range(this.numInputNodes),i.bind(this._getRandomInput,this),!1,0,!0)),this.nodesH=i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,s.biasNoChange),this.nodesS=i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,s.biasNoChange),this.nodesB=i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,s.biasNoChange),this.nodesDir=i.invoke(i.range(this.numProcessNodes),this._getRandomFunction,!1),this.constArr=new Float32Array(i.map(i.range(this.numProcessNodes),Math.random)),(s.biasHTree||s.biasSTree||s.biasBTree)&&(this.constArr[0]=.4*Math.random()+.3),s.biasSTree&&(this.nodesS[0]="ind"),s.biasBTree&&(this.nodesB[0]="ind"),t&&t.length>0){n=0;for(var r=0;this.numInputNodes>r;++r)this.inputsH[r]=parseInt(t[n]),this.inputsS[r]=parseInt(t[n+1]),this.inputsB[r]=parseInt(t[n+2]),this.inputsDir[r]=parseInt(t[n+3]),n+=4;for(var r=0;this.numProcessNodes>r;++r)this.nodesH[r]=t[n],this.nodesS[r]=t[n+1],this.nodesB[r]=t[n+2],this.nodesDir[r]=t[n+3],this.constArr[r]=parseFloat(t[n+4]),n+=5;return this}for(var r=0;e.length>r;++r)e[r]instanceof Array&&(this[h[r]]=e[r]);this.initialize.apply(this,arguments)};return i.extend(d.prototype,{initialize:r,clone:function(){return new d(new Uint8Array(this.inputsH),new Uint8Array(this.inputsS),new Uint8Array(this.inputsB),new Uint8Array(this.inputsDir),this.nodesH.slice(0),this.nodesS.slice(0),this.nodesB.slice(0),this.nodesDir.slice(0),new Float32Array(this.constArr))},mutate:function(t){var n=this.clone();return n.inputsH=i.map(n.inputsH,function(n){return e.probFn(n,t,this._getRandomInput,u.id,!1,0,!1)}),n.inputsS=i.map(n.inputsS,function(n){return e.probFn(n,t,this._getRandomInput,u.id,!1,1,!1)}),n.inputsB=i.map(n.inputsB,function(n){return e.probFn(n,t,this._getRandomInput,u.id,!1,2,!1)}),n.inputsDir=i.map(n.inputsDir,function(n){return e.probFn(n,t,this._getRandomInput,u.id,!1,0,!1)}),n.nodesH=i.map(n.nodesH,function(n){return e.probFn(n,t,this._getRandomFunction,u.id,!1)}),n.nodesS=i.map(n.nodesS,function(n){return e.probFn(n,t,this._getRandomFunction,u.id,!1)}),n.nodesB=i.map(n.nodesB,function(n){return e.probFn(n,t,this._getRandomFunction,u.id,!1)}),n.nodesDir=i.map(n.nodesDir,function(n){return e.probFn(n,t,function(){return Math.floor(Math.random()*u.length)},u.id)}),n.constArr=i.map(n.constArr,function(n){return e.probFn(n,t,function(t){return e.limit(t+.2*e.gaussRandom())},u.id)}),n},crossover:function(t){var n=.5,s=i.map(this.clone(),function(s,e){return i.map(s,function(i,s){return n>Math.random()?t[e][s]:i})});return new d(s)},evaluate:function(t){for(var n,i,s=new Float32Array(this.numTotalNodes),r=new Float32Array(this.numTotalNodes),a=new Float32Array(this.numTotalNodes),o=new Float32Array(this.numTotalNodes),h=this.numProcessNodes;this.numTotalNodes>h;h++)s[h]=t[this.inputsH[h-this.numProcessNodes]],r[h]=t[this.inputsS[h-this.numProcessNodes]],a[h]=t[this.inputsB[h-this.numProcessNodes]],o[h]=t[this.inputsDir[h-this.numProcessNodes]];for(var h=this.numProcessNodes-1;h>=0;h--)n=2*h+1,i=2*h+2,s[h]=e.ringify(u[this.nodesH[h]].apply(this,[s[n],s[i],h])),r[h]=e.ringify(u[this.nodesS[h]].apply(this,[r[n],r[i],h])),a[h]=e.ringify(u[this.nodesB[h]].apply(this,[a[n],a[i],h])),o[h]=e.ringify(u[this.nodesDir[h]].apply(this,[o[n],o[i],h]));return[s[0],r[0],a[0],o[0]]},toGenomeString:function(){for(var t="",n=0;this.numInputNodes>n;++n)t+=this.inputsH[n]+"!",t+=this.inputsS[n]+"!",t+=this.inputsB[n]+"!",t+=this.inputsDir[n]+"!";for(var n=0;this.numProcessNodes>n;++n)t+=this.nodesH[n]+"!",t+=this.nodesS[n]+"!",t+=this.nodesB[n]+"!",t+=this.nodesDir[n]+"!",t+=this.constArr[n]+"!";return t},_getRandomInput:function(t,n,i){var e=Math.random();return t?0===n?.33>e?11:.66>e?12:13:1===n?.33>e?8:.66>e?9:10:.2>e?1:.4>e?2:.6>e?3:.8>e?5:7:i?Math.floor(Math.random()*(s.agentInputs-1)+1):Math.random()*s.agentInputs},_getRandomFunction:function(t){var n=Math.random();return t?.01>n?"add":.02>n?"sub":.03>n?"mult":.04>n?"ind":.05>n?"max":.06>n?"min":.65>n?"id":.88>n?"realmean":.8>n?"div":.98>n?"incdec":.99>n?"sin":"inv":.05>n?"add":.1>n?"sub":.15>n?"mult":.25>n?"ind":.3>n?"max":.35>n?"min":.6>n?"id":.82>n?"realmean":.85>n?"div":.95>n?"incdec":.98>n?"sin":"inv"}}),n.initialize=function(t){return i.extend(s,t||{}),this},n});