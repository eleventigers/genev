"use strict";(function(t,i){"undefined"!=typeof exports?i(t,exports,require("underscore")):"function"==typeof define&&define.amd?define(["underscore","exports"],function(n,s){t.Genev=i(t,s,n)}):t.Genev=i(t,{},t._)})(this,function(t,i,n){i.VERSION="0.0.1";var s={gaussRandom:function(){var t,i,n;do t=2*Math.random()-1,i=2*Math.random()-1,n=t*t+i*i;while(n>=1||0===n);var s=Math.sqrt(-2*Math.log(n)/n);return t*s},limit:function(t,i,n){return i>t?i:t>n?n:t},ringify:function(t){return t>1?t-1:0>t?1+t:t},probFn:function(t,i,n,s){var e,r=Array.prototype.slice.call(arguments),i=i||0;return r.length>4&&(e=r.slice(4),e.unshift(t)),i>Math.random()?e?n.apply(null,e):n(t):e?s.apply(null,e):s(t)},parseBoolean:function(t){return"true"===t?!0:!1},populateArray:function(t,i){return n.map(new Float32Array(t),function(){return i instanceof Array?new Float32Array(i):i})},generateMatrix:function(t,i,n){return this.populateArray(t,this.populateArray(i,n))},probab:function(t,i){return i=i||Math.random,t>i()},toType:function(t){return{}.toString.call(t).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()},hsvToRgb:function(t,i,n){var s,e,r,o,h,a,u,d;if(0===i)return s=e=r=n,[Math.round(255*s),Math.round(255*e),Math.round(255*r)];switch(t*=6,o=Math.floor(t),h=t-o,a=n*(1-i),u=n*(1-i*h),d=n*(1-i*(1-h)),o){case 0:s=n,e=d,r=a;break;case 1:s=u,e=n,r=a;break;case 2:s=a,e=n,r=d;break;case 3:s=a,e=u,r=n;break;case 4:s=d,e=a,r=n;break;default:s=n,e=a,r=u}return[Math.round(255*s),Math.round(255*e),Math.round(255*r)]}},e=function(){},r={useColor:!0,useSaturation:!0,width:100,height:100,maxAgents:10,minAgents:3,wrapAround:!0},o=i.Individual=function(t){var i,e=Array.prototype.slice.call(arguments);if(this.options=r,"object"===s.toType(t)&&n.extend(this.options,t),"string"==typeof e[0]){i=e[0].split("::"),this.numAgents=parseInt(i[0]),this.width=parseInt(i[1]),this.height=parseInt(i[2]),this.wrapAround=s.parseBoolean(i[3]),this.startH=parseFloat(i[4]),this.startS=parseFloat(i[5]),this.startB=parseFloat(i[6]),this.agents=[];for(var o=0;this.numAgents>o;++o)this.agents[o]=new a(i[7+o]).setIndex(o)}else this.width=this.options.width,this.height=this.options.height,this.wrapAround=this.options.wrapAround,this.startH=this.options.startH||Math.random(),this.startS=this.options.startS||Math.random(),this.startB=this.options.startB||Math.random(),this.numAgents=this.options.numAgents||Math.round(Math.random()*(this.options.maxAgents-this.options.minAgents)+this.options.minAgents),this.agents=this.options.agents||this.generateAgents(this.numAgents,this.width,this.height,this.wrapAround);return this.maxTime=2*this.width*this.height,this.time=0,this.developed=!1,this.h=s.generateMatrix(this.width,this.height,this.startH),this.s=s.generateMatrix(this.width,this.height,this.startS),this.b=s.generateMatrix(this.width,this.height,this.startB),n.each(this.agents,function(t){t.wrapAround=this.wrapAround},this),this.initialize.apply(this,arguments),this};n.extend(o.prototype,{initialize:e,generateAgents:function(t,i,s,e){return t=t||this.numAgents,i=i||this.width,s=s||this.height,e=e||this.wrapAround,n.map(n.range(t),function(t,n){return new a({index:n,width:i,height:s,wrapAround:e})})},step:function(){var t,i;return this.developed?this:(++this.time,n.each(this.agents,function(n){t=n.step(this,this.time),t&&(i=t.currPos(),this.h[i.x][i.y]=t.h,this.s[i.x][i.y]=t.s,this.b[i.x][i.y]=t.b,t.nextPos())},this),this.time>=this.maxTime&&(this.developed=!0),this)},clone:function(){var t=n.map(this.agents,function(t,i,n){return n[i].clone().setIndex(i)},this);return new o({width:this.width,height:this.height,wrapAround:this.wrapAround,numAgents:this.numAgents,startH:this.startH,startS:this.startS,startB:this.startB,agents:t})},mutate:function(t){var i,e,h=this.numAgents,u=[],d=this.wrapAround,p=n.map([this.startH,this.startS,this.startB],function(i,n,e){return s.probab(t)?s.ringify(e[n]+s.gaussRandom()):e[n]});return s.probab(2*t)&&this.numAgents<r.maxAgents-1?(++h,u=n.map(n.range(h-1),function(t,i){return this.agents[i].clone().setIndex(i)},this),i=h-1,s.probab(.75)?u[i]=new a({index:i,width:this.width,height:this.height,wrapAround:this.wrapAround}):(e=Math.floor(Math.random()*i),u[h-1]=this.agents[e].clone().setIndex(i))):s.probab(2*t)&&this.numAgents>r.minAgents?(--h,u=n.map(n.range(h),function(t,i){return this.agents[i].clone().setIndex(i)},this),e=Math.floor(Math.random()*h),u[e]=this.agents[h].clone().setIndex(e)):u=n.map(n.range(h),function(t,i){return this.agents[i].clone().setIndex(i)},this),new o({width:this.width,height:this.height,wrapAround:d,numAgents:h,startH:p[0],startS:p[1],startB:p[2],agents:u})},crossover:function(t){var i,e,r=s.probab(.5)?t.numAgents:this.numAgents,h=s.probab(.5)?t.wrapAround:this.wrapAround,a=s.probab(.5)?t.startH:this.startH,u=s.probab(.5)?t.startS:this.startS,d=s.probab(.5)?t.startB:this.startB;return i=n.map(n.range(r),function(i,n){return s.probab(.33)?this.agents[Math.floor(Math.random()*this.numAgents)].clone().setIndex(n):s.probab(.5)?(e=t.agents[Math.floor(Math.random()*t.numAgents)],this.agents[Math.floor(Math.random()*this.numAgents)].crossover(e).setIndex(n)):this.agents[Math.floor(Math.random()*this.numAgents)].clone().setIndex(n)},this),new o({width:this.width,height:this.height,wrapAround:h,numAgents:r,startH:a,startS:u,startB:d,agents:i})},toGenomeString:function(){for(var t=this.numAgents+"::"+this.width+"::"+this.height+"::"+this.wrapAround+"::"+this.startH+"::"+this.startS+"::"+this.startB+"::",i=0;this.numAgents>i;++i)t+=this.agents[i].toGenomeString()+"::";return t},getRGBArr:function(){for(var t,i,n=this.width,e=this.height,r=this.h,o=this.s,h=this.b,a=new Uint8ClampedArray(4*n*e),u=0;e>u;++u){t=n*u;for(var d=0;n>d;++d)i=s.hsvToRgb(r[d][u],o[d][u],h[d][u]),a[4*(t+d)]=i[0],a[4*(t+d)+1]=i[1],a[4*(t+d)+2]=i[2],a[4*(t+d)+3]=255}return a}});var h={x:0,y:0,dir:0,delay:0,delayInt:0,stop:1,stopInt:99999999,gen:0,genTime1:0,genTime2:0,wrapAround:!0,index:1},a=i.Agent=function(t){var i,t=t||{},s=Array.prototype.slice.call(arguments);return this.genome=new g,n.extend(this,h),n.extend(this,this._randomizedAttributes()),1===s.length&&("string"==typeof s[0]?(i=s[0].split("#"),i&&(this.dir=parseInt(i[0]),this.gen=parseFloat(i[1]),this.genTime1=parseFloat(i[2]),this.genTime2=parseFloat(i[3]),this.delay=parseFloat(i[4]),this.stop=parseFloat(i[5]),this.width=parseInt(i[6]),this.height=parseInt(i[7]),this.genome=new g(i[8]))):n.extend(this,t)),n.extend(this,this._randomizedGridIndex()),this._originalAttributes=n.clone(this),this.initialize.apply(this,arguments),this};n.extend(a.prototype,{initialize:e,setIndex:function(t){return this.index=t,n.extend(this,this._randomizedAttributes()),this},mutate:function(t){var i,n=t>Math.random()?Math.floor(9*Math.random()):this._originalAttributes.dir,e=t>Math.random()?s.ringify(this.gen+.2*s.gaussRandom()):this.gen,r=t>Math.random()?s.ringify(this.genTime1+.2*s.gaussRandom()):this.genTime1,o=t>Math.random()?s.ringify(this.genTime2+.2*s.gaussRandom()):this.genTime2,h=t>Math.random()?s.ringify(this.delay+.1*s.gaussRandom()):this.delay,u=t>Math.random()?s.ringify(this.stop+.1*s.gaussRandom()):this.stop;return h>u&&(i=h,h=u,u=i),new a({x:this.x,y:this.y,width:this.width,height:this.height,wrapAround:this.wrapAround,genome:this.genome.mutate(t),dir:n,gen:e,genTime1:r,genTime2:o,delay:h,stop:u})},crossover:function(t){var i=.5,n=i>Math.random()?t.gen:this.gen,s=i>Math.random()?t.genTime1:this.genTime1,e=i>Math.random()?t.genTime2:this.genTime2,r=i>Math.random()?t.delay:this.delay,o=i>Math.random()?t.stop:this.stop;return new a({x:this.x,y:this.y,width:this.width,height:this.height,wrapAround:this.wrapAround,genome:this.genome.crossover(t.genome),dir:this._originalAttributes.dir,gen:n,genTime1:s,genTime2:e,delay:r,stop:o})},clone:function(){return new a({x:this._originalAttributes.x,y:this._originalAttributes.y,width:this._originalAttributes.width,height:this._originalAttributes.height,wrapAround:this._originalAttributes.wrapAround,dir:this._originalAttributes.dir,gen:this._originalAttributes.gen,genTime1:this._originalAttributes.genTime1,genTime2:this._originalAttributes.genTime2,delay:this._originalAttributes.delay,stop:this._originalAttributes.stop,genome:this.genome.clone()})},step:function(t,i){if(!(this.delayInt>i||i>this.stopInt)){var s=this.collectInputs(t,i),e=this.genome.evaluate(s),r=this._getNextPosition(this._floatToDir(e[3])),o={nextPos:n.partial(n.bind(function(t){return this.x=t.x,this.y=t.y,t},this),r),currPos:n.partial(function(t){return{x:t.x,y:t.y}},this),h:e[0],s:e[1],b:e[2]};return o}},collectInputs:function(t,i){for(var n,s,e,r,o,h,a,u,d,p,g,m,c=0,l=0,f=1,A=0,y=0,b=1e3*this.genTime1,b=1>b?1:b,w=1e3*this.genTime2,w=1>w?1:w,M=i%b/b,x=i%w/w,v=-1,_=-1,T=-1,I=-1,F=0,N=0,S=Math.random(),B=t.b[this.x][this.y],H=t.s[this.x][this.y],R=t.h[this.x][this.y],D=this._inverseDirection(this.dir),P=this._dirToFloat(D),k=this._getNextPosition(D),z=t.b[k.x][k.y],G=t.s[k.x][k.y],U=t.h[k.x][k.y],C=0,j=0,q=-1,E=0,L=Array(9),V=0;9>V;++V)n=this._getNextPosition(V,this.attributes),s=t.h[n.x][n.y],e=t.s[n.x][n.y],r=t.b[n.x][n.y],y+=s,A+=e,c+=r,o=Math.pow(s-B,2)+Math.pow(e-H,2)+Math.pow(r-B,2),o>q&&(q=o,E=V),r>l&&(l=r,C=V),f>r&&(f=r,j=V);c/=9,A/=9,y/=9,h=this._dirToFloat(C),a=this._dirToFloat(j),u=this._dirToFloat(E);for(var V=0;8>V;++V)n=this._getNextPosition(V,this.attributes),r=t.b[n.x][n.y],r>=c&&(L[V]=!0);for(var V=0;8>V;++V)d=Math.random(),p=Math.random(),g=V-1,g=1>g?7:g,m=V+1,m=m>=8?1:m,L[V]?((0>T||.3>d)&&(T=this._dirToFloat(V)),0!==L[g]&&0!==L[m]||!(0>_||.3>p)||(_=this._dirToFloat(V),N=_)):((0>I||.3>d)&&(I=this._dirToFloat(V)),0===L[g]&&0===L[m]||!(0>v||.3>p)||(v=this._dirToFloat(V),F=v));return T=0>T?this.gen:T,I=0>I?this.gen:I,v=0>v?this.gen:v,_=0>_?this.gen:_,[S,B,c,l,f,a,z,H,A,G,R,y,U,P,u,T,I,this.gen,M,x,v,_,t.startH,t.startS,t.startB,F,N]},toGenomeString:function(){var t=this._originalAttributes.dir+"#"+this._originalAttributes.gen+"#"+this._originalAttributes.genTime1+"#"+this._originalAttributes.genTime2+"#"+this._originalAttributes.delay+"#"+this._originalAttributes.stop+"#"+this._originalAttributes.width+"#"+this._originalAttributes.height+"#"+this.genome.toGenomeString()+"#";return t},_randomizedAttributes:function(t){t=t||Math.random();var i=Math.floor(9*Math.random()),n=Math.random(),s=Math.random(),e=Math.random(),r=.33>Math.random()?0:.33*Math.random(),o=.33>Math.random()?1:.66*Math.random()+.33;return.2>t?(r=0,o=.5*Math.random()):.4>t&&(r=.4000000059604645*Math.random()+.3,o=1),{dir:i,gen:n,genTime1:s,genTime2:e,delay:r,stop:o}},_randomizedGridIndex:function(){var t=2*this.width*this.height,i=Math.round(t*this.delay),n=Math.round(t*this.stop),s=Math.sqrt(r.maxAgents),e=this.index/s*(this.width/s)+.1*this.width,o=this.index%s*(this.height/s)+.1*this.height,e=e>=this.width?this.width-.2*this.width:e,o=o>=this.height?this.height-.2*this.height:o,h=Math.floor(e),a=Math.floor(o);return{delayInt:i,stopInt:n,x:h,y:a}},_getNextPosition:function(t){var i=[this.x,this.y],n=this.wrapAround,s=this.width,e=this.height;switch(t){case 1:i[0]-=1;break;case 2:i[0]-=1,i[1]-=1;break;case 3:i[1]-=1;break;case 4:i[0]+=1,i[1]-=1;break;case 5:i[0]+=1;break;case 6:i[0]+=1,i[1]+=1;break;case 7:i[1]+=1;break;case 8:i[0]-=1,i[1]+=1}return i[0]=0>i[0]?n?s-1:0:i[0],i[0]=i[0]>=s?n?0:s-1:i[0],i[1]=0>i[1]?n?e-1:0:i[1],i[1]=i[1]>=e?n?0:e-1:i[1],{x:i[0],y:i[1]}},_inverseDirection:function(t){var i;return 0===t?0:(i=(t+4)%8,0===i&&(i=8),i)},_dirToFloat:function(t){return t/9},_floatToDir:function(t){return parseInt(9*t)}});var u=["inputsH","inputsS","inputsB","inputsDir","nodesH","nodesS","nodesB","nodesDir","constArr"],d={add:function(t,i){return t+i},sub:function(t,i){return t-i},mult:function(t,i){return t*i},ind:function(t,i,n){return this.constArr[n]},min:function(t,i){return i>t?t:i},max:function(t,i){return t>i?t:i},sin:function(t){return Math.sin(t)},id:function(t){return t},mean:function(t,i){return t+i/2},realmean:function(t,i){return(t+i)/2},div:function(t,i){return Number.MIN_VALUE>i?t:Math.round(t/i)},incdec:function(t,i){return i>.5?t+.125:t-.125},inv:function(t){return 1-t}},p={agentTreeDepth:3,agentInputs:27,biasHTree:!1,biasSTree:!1,biasBTree:!1,biasNoChange:!1},g=i.Genome=function(){var t,i,e,r=Array.prototype.slice.apply(arguments),o=[];if(this.options={},"array"===s.toType(r[0])?(o=r[0],t=r[1]||{}):1===r.length&&"string"==typeof r[0]?(i=r[0].split("!"),t=r[1]||{}):"object"===s.toType(r[0])&&(t=r[0]),n.extend(this.options,p,t),this.numTotalNodes=Math.floor(Math.pow(2,this.options.agentTreeDepth+1)-1),this.numInputNodes=Math.floor(Math.pow(2,this.options.agentTreeDepth)),this.numProcessNodes=this.numTotalNodes-this.numInputNodes,this.inputsH=new Uint8Array(n.invoke(n.range(this.numInputNodes),n.bind(this._getRandomInput,this),this.options.biasNoChange,0,!0)),this.inputsS=new Uint8Array(n.invoke(n.range(this.numInputNodes),n.bind(this._getRandomInput,this),this.options.biasNoChange,1,!0)),this.inputsB=new Uint8Array(n.invoke(n.range(this.numInputNodes),n.bind(this._getRandomInput,this),this.options.biasNoChange,2,!0)),this.inputsDir=new Uint8Array(n.invoke(n.range(this.numInputNodes),n.bind(this._getRandomInput,this),!1,0,!0)),this.nodesH=n.invoke(n.range(this.numProcessNodes),this._getRandomFunction,this.options.biasNoChange),this.nodesS=n.invoke(n.range(this.numProcessNodes),this._getRandomFunction,this.options.biasNoChange),this.nodesB=n.invoke(n.range(this.numProcessNodes),this._getRandomFunction,this.options.biasNoChange),this.nodesDir=n.invoke(n.range(this.numProcessNodes),this._getRandomFunction,!1),this.constArr=new Float32Array(n.map(n.range(this.numProcessNodes),Math.random)),(this.options.biasHTree||this.options.biasSTree||this.options.biasBTree)&&(this.constArr[0]=.4*Math.random()+.3),this.options.biasSTree&&(this.nodesS[0]="ind"),this.options.biasBTree&&(this.nodesB[0]="ind"),i&&i.length>0){e=0;for(var h=0;this.numInputNodes>h;++h)this.inputsH[h]=parseInt(i[e]),this.inputsS[h]=parseInt(i[e+1]),this.inputsB[h]=parseInt(i[e+2]),this.inputsDir[h]=parseInt(i[e+3]),e+=4;for(var h=0;this.numProcessNodes>h;++h)this.nodesH[h]=i[e],this.nodesS[h]=i[e+1],this.nodesB[h]=i[e+2],this.nodesDir[h]=i[e+3],this.constArr[h]=parseFloat(i[e+4]),e+=5;return this}for(var h=0;o.length>h;++h)(o[h]instanceof Array||o[h]instanceof Uint8Array||o[h]instanceof Float32Array)&&(this[u[h]]=o[h]);this.initialize.apply(this,arguments)};n.extend(g.prototype,{initialize:e,clone:function(){return new g([new Uint8Array(this.inputsH),new Uint8Array(this.inputsS),new Uint8Array(this.inputsB),new Uint8Array(this.inputsDir),this.nodesH.slice(0),this.nodesS.slice(0),this.nodesB.slice(0),this.nodesDir.slice(0),new Float32Array(this.constArr)],this.options)},mutate:function(t){var i=this.clone();return i.inputsH=n.map(i.inputsH,function(i){return s.probFn(i,t,this._getRandomInput,d.id,!1,0,!1)}),i.inputsS=n.map(i.inputsS,function(i){return s.probFn(i,t,this._getRandomInput,d.id,!1,1,!1)}),i.inputsB=n.map(i.inputsB,function(i){return s.probFn(i,t,this._getRandomInput,d.id,!1,2,!1)}),i.inputsDir=n.map(i.inputsDir,function(i){return s.probFn(i,t,this._getRandomInput,d.id,!1,0,!1)}),i.nodesH=n.map(i.nodesH,function(i){return s.probFn(i,t,this._getRandomFunction,d.id,!1)}),i.nodesS=n.map(i.nodesS,function(i){return s.probFn(i,t,this._getRandomFunction,d.id,!1)}),i.nodesB=n.map(i.nodesB,function(i){return s.probFn(i,t,this._getRandomFunction,d.id,!1)}),i.nodesDir=n.map(i.nodesDir,function(i){return s.probFn(i,t,function(){return Math.floor(Math.random()*d.length)},d.id)}),i.constArr=n.map(i.constArr,function(i){return s.probFn(i,t,function(t){return s.limit(t+.2*s.gaussRandom())},d.id)}),i},crossover:function(t){if(t instanceof g){var i,s=.5,e=n.pick(this,"inputsH","inputsS","inputsB","inputsDir","nodesH","nodesS","nodesB","nodesDir","constArr"),r=n.map(e,function(e,r){return i=n.map(e,function(i,n){return s>Math.random()?t[r][n]||i:i||t[r][n]})}),o={};return n.each(this.options,function(i,n){o[n]=i>=t.options[n]?i:t.options[n]}),new g(r,o)}throw new TypeError("Genev.js: to crossover a genome, another genome must be provided!")},evaluate:function(t){for(var i,n,e=new Float32Array(this.numTotalNodes),r=new Float32Array(this.numTotalNodes),o=new Float32Array(this.numTotalNodes),h=new Float32Array(this.numTotalNodes),a=this.numProcessNodes;this.numTotalNodes>a;a++)e[a]=t[this.inputsH[a-this.numProcessNodes]],r[a]=t[this.inputsS[a-this.numProcessNodes]],o[a]=t[this.inputsB[a-this.numProcessNodes]],h[a]=t[this.inputsDir[a-this.numProcessNodes]];for(var a=this.numProcessNodes-1;a>=0;a--)i=2*a+1,n=2*a+2,e[a]=s.ringify(d[this.nodesH[a]].apply(this,[e[i],e[n],a])),r[a]=s.ringify(d[this.nodesS[a]].apply(this,[r[i],r[n],a])),o[a]=s.ringify(d[this.nodesB[a]].apply(this,[o[i],o[n],a])),h[a]=s.ringify(d[this.nodesDir[a]].apply(this,[h[i],h[n],a]));return[e[0],r[0],o[0],h[0]]},toGenomeString:function(){for(var t="",i=0;this.numInputNodes>i;++i)t+=this.inputsH[i]+"!",t+=this.inputsS[i]+"!",t+=this.inputsB[i]+"!",t+=this.inputsDir[i]+"!";for(var i=0;this.numProcessNodes>i;++i)t+=this.nodesH[i]+"!",t+=this.nodesS[i]+"!",t+=this.nodesB[i]+"!",t+=this.nodesDir[i]+"!",t+=this.constArr[i]+"!";return t},_getRandomInput:function(t,i,n){var s=Math.random();return t?0===i?.33>s?11:.66>s?12:13:1===i?.33>s?8:.66>s?9:10:.2>s?1:.4>s?2:.6>s?3:.8>s?5:7:n?Math.floor(Math.random()*(this.options.agentInputs-1)+1):Math.random()*this.options.agentInputs},_getRandomFunction:function(t){var i=Math.random();return t?.01>i?"add":.02>i?"sub":.03>i?"mult":.04>i?"ind":.05>i?"max":.06>i?"min":.65>i?"id":.88>i?"realmean":.8>i?"div":.98>i?"incdec":.99>i?"sin":"inv":.05>i?"add":.1>i?"sub":.15>i?"mult":.25>i?"ind":.3>i?"max":.35>i?"min":.6>i?"id":.82>i?"realmean":.85>i?"div":.95>i?"incdec":.98>i?"sin":"inv"}});var m=function(t,i){var s,e=this;s=t&&n.has(t,"constructor")?t.constructor:function(){return e.apply(this,arguments)},n.extend(s,e,i);var r=function(){this.constructor=s};return r.prototype=e.prototype,s.prototype=new r,t&&n.extend(s.prototype,t),s.__super__=e.prototype,s};return o.extend=a.extend=g.extend=m,i});